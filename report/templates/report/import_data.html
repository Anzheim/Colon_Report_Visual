<!-- templates/import_data.html -->
{% extends "base.html" %}

{% block content %}
    <h1>新增病歷資料</h1>
    <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="files-data" name="files-data">
        <input type="file" id="folder-upload" name="file" accept=".txt, image/*" webkitdirectory directory multiple>
        <button type="submit">上傳資料</button>
    </form>
    <div id="folder-name"></div>

    <script>
        document.getElementById('folder-upload').addEventListener('change', function(e){
            let secondDir = "";
            let fileData = [];
            let files = e.target.files;
            // console.log(event.target.files);
            for(file of event.target.files){
                // console.log(file.name)
                // console.log(file.webkitRelativePath);
                let relatibePath = file.webkitRelativePath;
                let pathParts = relatibePath.split('/');
                if (pathParts.length > 2) {
                    secondDir = pathParts[1]; // second-level directory
                    fileData.push({
                    filename:pathParts[pathParts.length-1],
                    secondDir:secondDir
                });
                }
            }
            console.log(fileData);
            document.getElementById('folder-name').innerHTML = "上傳檔案預覽: <br>" + fileData.map(data => `${data.secondDir}/${data.filename}`).join('<br>');
            document.getElementById('files-data').value = JSON.stringify(fileData);
        });
        document.getElementById('upload-form').addEventListener('submit', function (event) {
            var input = document.getElementById('folder-upload');
            if (input.files.length === 0) {
                alert('請選擇一個文件夾!');
                event.preventDefault();
            }
        });
    </script>

    <p><pre>{{ result }}</pre></p>
{% endblock %}